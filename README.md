# Проект "Web Calculator"

Этот проект представляет собой калькулятор, который обрабатывает математические выражения через REST API. Он состоит из двух основных компонентов:

1. **Оркестратор** (Orchestrator) — управляет задачами и координирует работу агентов.
2. **Агент** (Agent) — выполняет вычисления выражений, полученных от оркестратора.
   
Если что-то не работает, пишите в Telegram: [gulovv](https://t.me/gulovv).

## Технологии

- **Go** — язык программирования для реализации сервисов.
- **Docker** — для контейнеризации сервисов.
- **Docker Compose** — для запуска нескольких сервисов с одной конфигурацией.

## Установка

Для установки проекта на вашем компьютере выполните следующие шаги.

**✅1. Клонируйте репозиторий:**


   ```bash
   git clone https://github.com/gulovv/web_calculator.git
```

**✅2. Соберите и запустите образы Docker**:

   В директории проекта выполните команду:
   ```bash
   docker-compose up --build
```

**✅3. Запуск Docker контейнеров**

   После выполнения команды `docker-compose up --build` в терминале будет выведено следующее сообщение, это означает, что оба сервиса (агент и оркестратор) были собраны и перезапущены:
   ```bash
   ✔ Service agent                            Built                                                                3.4s 
   ✔ Service orchestrator                     Built                                                                3.0s 
   ✔ Container web_calculator-agent-1         Recreated                                                            0.3s 
   ✔ Container web_calculator-orchestrator-1  Recreated                                                            0.3s
   Attaching to agent-1, orchestrator-1
   agent-1         | Ошибка получения задачи: Get “http://orchestrator:8080/api/v1/task”: dial tcp 172.22.0.2:8080: connect: connection refused
   orchestrator-1  | Запуск сервера Оркестратора…
   orchestrator-1  | Сервер Оркестратора запущен на http://localhost:8080
```

**✅4. Работа с проектом через терминал**

   Для взаимодействия с проектом необходимо использовать cURL запросы. Рекомендуется открыть отдельный терминал для выполнения этих запросов. Если что-то не работает, пишите в Telegram: [gulovv](https://t.me/gulovv).

## Эндпоинты API

Проект предоставляет несколько эндпоинтов для взаимодействия с системой через REST API. Далее представлены все доступные эндпоинты и примеры использования cURL запросов.

## Общие ошибки, которые могут возникнуть в любом эндпоинте:

| Код ошибки         | Описание                                                                                                                                   |
|--------------------|--------------------------------------------------------------------------------------------------------------------------------------------|
| **400 Bad Request❌** | Этот код ошибки возникает, когда запрос не может быть обработан сервером из-за некорректных данных, отправленных в запросе. Ошибка может быть вызвана, например, если ID имеет неправильный формат (не число) или если выражение для вычисления содержит недопустимые символы. |
| **404 Not Found❌**   | Этот код ошибки возвращается, если запрашиваемый ресурс не найден на сервере. Это может произойти, если, например, задача с указанным ID не существует или был сделан запрос к несуществующему маршруту. |
| **500 Internal Server Error❌** | Этот код ошибки указывает на то, что произошла непредвиденная ошибка на сервере, из-за которой он не смог выполнить запрос. Обычно такая ошибка возникает при внутренних сбоях, например, при ошибке обработки данных, проблемах с подключением к базе данных или других сбоях в логике работы сервера. |
### ✅1. **Добавление вычисления арифметического выражения**

**POST /api/v1/calculate**

Этот эндпоинт позволяет добавить новое выражение для вычисления.

**Пример запроса:**

```bash
curl -X POST http://localhost:8080/api/v1/calculate \
    -H "Content-Type: application/json" \
    -d '{"expression": "2 * 9 + 8"}'
```

**Ответ:**

```json
{
  "id": 2
}
```

**Потенциальные ошибки:**

*•	⬆️422 Unprocessable Entity — если тело запроса содержит некорректные данные, например, неверное выражение.*

*•	⬆️400 Bad Request — если выражение не передано или пустое.*

*•	⬆️500 Internal Server Error — если произошла ошибка при обработке запроса.*


### ✅2. **Получение агентом задачи для выполнения**

**GET /api/v1/task**

**Пример запроса:**

```bash
curl -X GET http://localhost:8080/api/v1/task
```

**Ответ:**

```json
{
  "task": {
    "id": 1,
    "expression": "2 * 9 + 8",
    "status": "pending",
    "result": null
  }
}
```

**Потенциальные ошибки:**

*•	⬆️404 Not Found — если нет доступных задач в очереди.*

Примечание: Этот эндпоинт используется агентом для получения задачи с оркестратора. Агент отправляет запрос к этому эндпоинту, парсит ответ и выполняет вычисления. После выполнения задачи агент отправляет результат на оркестратор с помощью другого эндпоинта.

**Агент выполняет следующий цикл:**

1.	Периодически делает запрос к /api/v1/task, чтобы получить задачу.
 
2.	Если задача завершена (статус completed), агент пропускает её.
 
3.	Если задача не завершена (статус pending), агент вычисляет результат.
 
4.	После вычисления агент отправляет результат обратно на оркестратор через эндпоинт /api/v1/task/result.
 
### ✅3. **Обновление результата задачи**

**POST /api/v1/task/result**

Этот эндпоинт используется агентом для отправки результата выполнения задачи на оркестратор. Агент отправляет вычисленный результат задачи после выполнения математического выражения.


**Пример запроса, отправленного агентом:**
```bach
curl -X POST http://orchestrator:8080/api/v1/task/result \
    -H "Content-Type: application/json" \
    -d '{
        "id": 1,
        "expression": "2 * 9 + 8",
        "status": "completed",
        "result": 26
    }
```

**Ответ оркестратора**
```json
{
  "id": 1,
  "expression": "2 * 9 + 8",
  "status": "completed",
  "result": 26
}
```

**Потенциальные ошибки:**

*•	⬆️400 Bad Request — если задача уже завершена.*

*•	⬆️404 Not Found — если задача с указанным ID не найдена.*

*•	⬆️500 Internal Server Error — если произошла внутренняя ошибка сервера.*

**Описание работы эндпоинта:**


1.	Агент отправляет запрос на оркестратор, чтобы обновить задачу после её вычисления.
2.	В теле запроса передаются:
   
	•	id — идентификатор задачи.

	•	expression — исходное математическое выражение.

	•	status — статус задачи, который должен быть "completed" (выполнено).

	•	result — вычисленный результат.

3.	Оркестратор проверяет, была ли задача уже завершена:

Если задача уже завершена, сервер вернёт ошибку с кодом 400 Bad Request и сообщением: "Задача уже завершена", если задача не завершена, результат сохраняется и задача обновляется.

4.	Обновлённая задача сохраняется в истории завершённых задач (completedTasks), а сама задача удаляется из очереди.
5.	В ответе оркестратор отправляет обновлённую задачу.

**Важные моменты:**

•	Код использует блокировку с помощью taskMutex.Lock() и defer taskMutex.Unlock(), чтобы безопасно работать с общими данными в многозадачной среде.
 
•	Если задача была найдена и не завершена, её результат обновляется, задача сохраняется в истории, а из очереди она удаляется.
 
•	В случае ошибки, такой как некорректные данные или уже завершённая задача, оркестратор возвращает соответствующую ошибку с кодом ответа 400 Bad Request.
 
•	Если задача с указанным идентификатором не найдена, сервер возвращает ошибку 404 Not Found.

Примечание: Этот эндпоинт используется только агентом для отправки результатов после вычислений.


### ✅4. Удаление всех задач

**DELETE /api/v1/tasks/delete**


Этот эндпоинт используется для удаления всех задач из очереди. 

**Пример запроса:**
```bach
curl -X DELETE http://localhost:8080/api/v1/tasks/delete
```
**Пример ответа:**
```json
{
  "message": "Все задачи успешно удалены"
}
```

**Потенциальные ошибки:**

*•	⬆️500 Internal Server Error — если произошла ошибка при удалении всех задач.*

### ✅5. Получение выражения по его идентификатору

**GET /api/v1/expressions/:id**

Этот эндпоинт используется для получения информации о конкретном выражении по его уникальному идентификатору.

**Пример запроса:**
```bach
curl -X GET http://localhost:8080/api/v1/expressions/1
```

**Пример ответа**

```json
{
  "expression": {
    "id": 1,
    "status": "completed",
    "result": 20.0
  }
}
```
**Потенциальные ошибки:**

*•	⬆️400 Bad Request — если ID не является числом.*
 
*•	⬆️404 Not Found — если задача с данным ID не найдена.*

### ✅6. Получение списка всех выражений

**GET /api/v1/expressions**

Этот эндпоинт используется для получения списка всех выражений, которые были добавлены для вычисления.


**Пример запроса:**

```bach
curl -X GET http://localhost:8080/api/v1/expressions
```

**Пример ответа**
```json
{
  "expressions": [
    {
      "id": 11,
      "status": "completed",
      "result": 12.0
    },
    {
      "id": 12,
      "status": "completed",
      "result": 25.5
    },
    {
      "id": 13,
      "status": "completed",
      "result": 100.1
    }
  ]
}
```

**Потенциальные ошибки:**
	
*•	⬆️500 Internal Server Error — если произошла ошибка при обработке запроса.*

